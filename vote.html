<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íˆ¬í‘œí•˜ê¸°</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    input, button, select { padding: 10px 12px; border: 1px solid #ccc; border-radius: 10px; }
    button { cursor: pointer; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; }
    .small { color:#666; font-size:12px; }
    ul.list { list-style:none; padding:0; margin:0; }
    ul.list li { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid #eee; border-radius:10px; margin:8px 0; background:#fafafa; }
    .badge { font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; }
    a { word-break: break-all; }
  </style>
</head>
<body>
  <h1>íˆ¬í‘œí•˜ê¸°</h1>

  <!-- ì„¸ì…˜ ë¡œë“œ -->
  <div class="card">
    <h2>1) ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°</h2>
    <div class="row">
      <input id="sessionId" placeholder="session UUID" style="flex:1; min-width:260px;" />
      <button id="loadSession">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span id="loadMsg" class="small"></span>
    </div>
    <p class="small">ë³´í†µì€ ë°©ì¥ì´ ì¤€ ë§í¬ë¡œ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤. (session=...)</p>
  </div>

  <!-- íˆ¬í‘œ UI -->
  <div id="voteCard" class="card" style="display:none;">
    <h2 id="sessionTitle"></h2>
    <p id="sessionMeta" class="small"></p>

    <h3>2) ë‚˜ëŠ” ëˆ„êµ¬?</h3>
    <div class="row">
      <select id="meSelect" style="min-width:220px;"></select>
      <button id="makeAnonToken">ìµëª… í† í° ìƒì„±/ê°±ì‹ </button>
      <span id="tokenMsg" class="small"></span>
    </div>
    <p class="small">
      - ë³¸ì¸ì€ í›„ë³´ì—ì„œ ìë™ ì œì™¸ë©ë‹ˆë‹¤.<br/>
      - ìµëª… í† í°ì€ ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ë¥¼ ìœ„í•œ ê°’ì´ë©°, ì´ë¦„ì€ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>

    <hr/>

    <h3>3) ìˆœìœ„ ì •í•˜ê¸° (ë“œë˜ê·¸ë¡œ ì •ë ¬)</h3>
    <ul id="rankList" class="list"></ul>

    <div class="row">
      <button id="submitVote">ì œì¶œ</button>
      <span id="voteMsg" class="small"></span>
    </div>
  </div>

  <p><a href="./index.html">í™ˆìœ¼ë¡œ</a></p>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/supabase.js"></script>

  <script>
    // -------------------------
    // ìœ í‹¸
    // -------------------------
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const esc = (s)=> (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    // âœ… ê²°ê³¼ í˜ì´ì§€ ë§í¬ HTML ìƒì„±
    function resultLinkHTML(sessionId) {
      const base = location.href.replace(/vote\.html(\?.*)?$/, "");
      const url = `${base}result.html?session=${sessionId}`;
      return `
        ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤<br/>
        <a href="${url}" target="_blank">ğŸ‘‰ ê²°ê³¼ í˜ì´ì§€ ë³´ê¸°</a>
      `;
    }

    // ìµëª… í† í°: ì„¸ì…˜ë³„ë¡œ 1ê°œ ì €ì¥(ë¡œì»¬ìŠ¤í† ë¦¬ì§€)
    function tokenKey(sessionId){ return `rankvote_token_${sessionId}`; }
    function getToken(sessionId){ return localStorage.getItem(tokenKey(sessionId)); }
    function setToken(sessionId, token){ localStorage.setItem(tokenKey(sessionId), token); }

    // -------------------------
    // ì¤‘ë³µ íˆ¬í‘œ ì²´í¬(ì„¸ì…˜ + í† í° ê¸°ì¤€)
    // -------------------------
    async function checkAlreadyVoted(sessionId) {
      const msg = document.getElementById("voteMsg");
      const submitBtn = document.getElementById("submitVote");

      const token = getToken(sessionId);
      if (!token) {
        // í† í°ì´ ì—†ìœ¼ë©´ ì•„ì§ íˆ¬í‘œ ì „ìœ¼ë¡œ ê°„ì£¼
        submitBtn.disabled = false;
        msg.textContent = "";
        return false;
      }

      const { data, error } = await sb
        .from("votes")
        .select("id")
        .eq("session_id", sessionId)
        .eq("voter_hash", token)
        .limit(1);

      if (error) {
        // í™•ì¸ ì‹¤íŒ¨ ì‹œì—ë„ íˆ¬í‘œëŠ” ê°€ëŠ¥í•˜ê²Œ ë‘  (ë‹¨, ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ)
        msg.textContent = "íˆ¬í‘œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: " + error.message;
        submitBtn.disabled = false;
        return false;
      }

      const voted = (data && data.length > 0);
      if (voted) {
        // âœ… ë§í¬ í¬í•¨ ë©”ì‹œì§€ + ë²„íŠ¼ ë¹„í™œì„±í™”
        msg.innerHTML = resultLinkHTML(sessionId);
        submitBtn.disabled = true;
      } else {
        msg.textContent = "";
        submitBtn.disabled = false;
      }
      return voted;
    }

    // -------------------------
    // ìƒíƒœ
    // -------------------------
    let session = null;
    let peopleMap = new Map();
    let sortable = null;

    // session íŒŒë¼ë¯¸í„° ìë™ ì…ë ¥
    const sp = qs("session");
    if (sp) document.getElementById("sessionId").value = sp;

    // -------------------------
    // ë Œë”ë§
    // -------------------------
    async function fetchPeopleByIds(ids) {
      const { data, error } = await sb
        .from("people")
        .select("id,name,is_active")
        .in("id", ids);

      if (error) throw error;

      // ë¹„í™œì„± ì¸ì›ì€ íˆ¬í‘œ í›„ë³´ì—ì„œ ì œì™¸(ì„¸ì…˜ì— ë“¤ì–´ìˆë”ë¼ë„)
      const active = data.filter(p => p.is_active !== false);
      peopleMap = new Map(active.map(p => [p.id, p]));
    }

    function renderMeSelect(candidateIds) {
      const sel = document.getElementById("meSelect");
      const opts = candidateIds
        .filter(id => peopleMap.has(id))
        .map(id => {
          const p = peopleMap.get(id);
          return `<option value="${p.id}">${esc(p.name)}</option>`;
        });

      sel.innerHTML = `<option value="">(ì„ íƒ)</option>` + opts.join("");
    }

    function renderRankList(candidateIds, meId) {
      const list = document.getElementById("rankList");

      // ë³¸ì¸ì€ ì œì™¸
      const filtered = candidateIds.filter(id => peopleMap.has(id) && id !== meId);

      list.innerHTML = filtered.map((id, idx) => {
        const p = peopleMap.get(id);
        return `
          <li data-id="${id}">
            <span>${idx + 1}ìœ„ â€” ${esc(p.name)}</span>
            <span class="badge">drag</span>
          </li>
        `;
      }).join("");

      if (sortable) sortable.destroy();
      sortable = new Sortable(list, {
        animation: 150,
        onSort: () => {
          // ìˆœìœ„ë²ˆí˜¸ ì¬í‘œì‹œ
          Array.from(list.querySelectorAll("li")).forEach((li, i) => {
            const name = li.querySelector("span").textContent.split("â€”")[1].trim();
            li.querySelector("span").textContent = `${i + 1}ìœ„ â€” ${name}`;
          });
        }
      });
    }

    // -------------------------
    // ì„¸ì…˜ ë¡œë“œ
    // -------------------------
    async function loadSession() {
      const sessionId = document.getElementById("sessionId").value.trim();
      if (!sessionId) return;

      document.getElementById("loadMsg").textContent = "ì„¸ì…˜ ë¡œë“œ ì¤‘...";

      const { data, error } = await sb.from("sessions").select("*").eq("id", sessionId).single();
      if (error) {
        document.getElementById("loadMsg").textContent = "ë¡œë“œ ì‹¤íŒ¨: " + error.message;
        return;
      }
      session = data;

      // í›„ë³´ ì‚¬ëŒë“¤ ë¡œë“œ
      try {
        await fetchPeopleByIds(session.candidate_ids);
      } catch (e) {
        document.getElementById("loadMsg").textContent = "í›„ë³´ ë¡œë“œ ì‹¤íŒ¨: " + (e.message ?? e);
        return;
      }

      document.getElementById("voteCard").style.display = "block";
      document.getElementById("sessionTitle").textContent = session.title;
      document.getElementById("sessionMeta").textContent =
        `í›„ë³´ ${peopleMap.size}ëª… Â· ë°©ì‹: ${session.top_k === 0 ? "ì „ì²´ ìˆœìœ„" : `Top-${session.top_k}`}`;

      renderMeSelect(session.candidate_ids);
      renderRankList(session.candidate_ids, "");

      // ìµëª… í† í° ìƒíƒœ í‘œì‹œ
      const t = getToken(session.id);
      document.getElementById("tokenMsg").textContent = t ? "ìµëª… í† í°: (ì €ì¥ë¨)" : "ìµëª… í† í°: (ì—†ìŒ)";

      // âœ… ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸ (ìˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™” + ë§í¬ í‘œì‹œ)
      await checkAlreadyVoted(session.id);

      document.getElementById("loadMsg").textContent = "ë¡œë“œ ì™„ë£Œ";
    }

    document.getElementById("loadSession").addEventListener("click", loadSession);
    if (sp) loadSession();

    // -------------------------
    // ë³¸ì¸ ì„ íƒ ë³€ê²½ ì‹œ í›„ë³´ ì¬ë Œë”
    // -------------------------
    document.getElementById("meSelect").addEventListener("change", () => {
      if (!session) return;
      const meId = document.getElementById("meSelect").value;
      renderRankList(session.candidate_ids, meId);
    });

    // -------------------------
    // ìµëª… í† í° ìƒì„±/ê°±ì‹ 
    // -------------------------
    document.getElementById("makeAnonToken").addEventListener("click", async () => {
      if (!session) {
        document.getElementById("tokenMsg").textContent = "ì„¸ì…˜ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
        return;
      }
      const token = crypto.randomUUID(); // ë¸Œë¼ìš°ì € ë‚´ ìƒì„±
      setToken(session.id, token);
      document.getElementById("tokenMsg").textContent = "ìµëª… í† í°: (ìƒˆë¡œ ì €ì¥ë¨)";

      // í† í°ì„ ìƒˆë¡œ ë§Œë“¤ë©´ "ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€" ìƒíƒœê°€ ë°”ë€” ìˆ˜ ìˆì–´ ì¬í™•ì¸
      await checkAlreadyVoted(session.id);
    });

    // -------------------------
    // ì œì¶œ
    // -------------------------
    document.getElementById("submitVote").addEventListener("click", async () => {
      const msg = document.getElementById("voteMsg");
      msg.textContent = "";

      if (!session) { msg.textContent = "ì„¸ì…˜ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”."; return; }

      // ì´ë¯¸ íˆ¬í‘œí•œ ìƒíƒœë©´ ì¦‰ì‹œ ì°¨ë‹¨
      const already = await checkAlreadyVoted(session.id);
      if (already) return;

      const meId = document.getElementById("meSelect").value;
      if (!meId) { msg.textContent = "â€˜ë‚˜ëŠ” ëˆ„êµ¬?â€™ë¥¼ ì„ íƒí•˜ì„¸ìš”."; return; }

      // í† í° ì—†ìœ¼ë©´ ìë™ ìƒì„±(UX ì¢‹ê²Œ)
      let token = getToken(session.id);
      if (!token) {
        token = crypto.randomUUID();
        setToken(session.id, token);
        document.getElementById("tokenMsg").textContent = "ìµëª… í† í°: (ìë™ ìƒì„±ë¨)";
      }

      // í˜„ì¬ ì •ë ¬ëœ ìˆœìœ„ ê°€ì ¸ì˜¤ê¸°
      const ids = Array.from(document.querySelectorAll("#rankList li"))
        .map(li => li.getAttribute("data-id"));

      // Top-k ì²˜ë¦¬
      const finalRanking = (session.top_k > 0) ? ids.slice(0, session.top_k) : ids;

      // ë³¸ì¸ í¬í•¨ ì—¬ë¶€(í”„ë¡ íŠ¸ ë°©ì–´ + DB ì œì•½ì´ ìµœì¢… ë°©ì–´)
      if (finalRanking.includes(meId)) {
        msg.textContent = "ë³¸ì¸ì€ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // ìµœì†Œ 1ëª… ì´ìƒì€ ë­í‚¹ì´ ìˆì–´ì•¼ ì˜ë¯¸ ìˆìŒ (ì •ì±…ì€ ì·¨í–¥)
      if (finalRanking.length < 1) {
        msg.textContent = "ìˆœìœ„ë¥¼ ìµœì†Œ 1ëª… ì´ìƒ ì§€ì •í•˜ì„¸ìš”.";
        return;
      }

      msg.textContent = "ì œì¶œ ì¤‘...";

      const payload = {
        session_id: session.id,
        voter_person_id: meId,
        voter_hash: token,
        ranking: finalRanking
      };

      const { error } = await sb.from("votes").insert(payload);

      if (error) {
        // âœ… ì¤‘ë³µ íˆ¬í‘œ(ìœ ë‹ˆí¬ ì œì•½)ë©´ ë§í¬ í¬í•¨ ë™ì¼ ë¬¸êµ¬ë¡œ ì²˜ë¦¬
        const em = (error.message || "").toLowerCase();
        if (em.includes("duplicate") || em.includes("unique")) {
          msg.innerHTML = resultLinkHTML(session.id);
          document.getElementById("submitVote").disabled = true;
          return;
        }
        msg.textContent = "ì œì¶œ ì‹¤íŒ¨: " + error.message;
        return;
      }

      // âœ… ì œì¶œ ì„±ê³µ í›„: ë§í¬ í¬í•¨ ë¬¸êµ¬ + ë²„íŠ¼ ë¹„í™œì„±í™”
      msg.innerHTML = resultLinkHTML(session.id);
      document.getElementById("submitVote").disabled = true;
    });
  </script>
</body>
</html>
